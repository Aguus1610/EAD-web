{% extends "base.html" %}

{% block title %}{% if cliente %}Editar Cliente{% else %}Nuevo Cliente{% endif %} - EAD Oleohidráulica{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-2">
    <div class="container-fluid">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/"><i class="bi bi-house"></i> Inicio</a></li>
            <li class="breadcrumb-item"><a href="/clientes"><i class="bi bi-people"></i> Clientes</a></li>
            {% if cliente %}
            <li class="breadcrumb-item"><a href="/cliente/{{ cliente.id }}">{{ cliente.nombre }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Editar</li>
            {% else %}
            <li class="breadcrumb-item active" aria-current="page">Nuevo Cliente</li>
            {% endif %}
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="animate-slide">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header {% if cliente %}bg-warning{% else %}bg-primary{% endif %} text-white">
                    <h5 class="mb-0">
                        <i class="bi {% if cliente %}bi-pencil{% else %}bi-person-plus{% endif %}"></i>
                        {% if cliente %}Editar Cliente{% else %}Nuevo Cliente{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="clienteForm" class="needs-validation" novalidate>
                        <div class="row">
                            <!-- Información Básica -->
                            <div class="col-12">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-person-circle"></i> Información Básica
                                </h6>
                            </div>
                            
                            <!-- Nombre -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="nombre" class="form-label">
                                    <i class="bi bi-person"></i> Nombre Completo <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="nombre" 
                                       name="nombre"
                                       value="{{ cliente.nombre if cliente else '' }}" 
                                       required
                                       maxlength="100"
                                       placeholder="Nombre completo del cliente">
                                <div class="invalid-feedback">
                                    El nombre del cliente es obligatorio.
                                </div>
                            </div>
                            
                            <!-- Tipo de Cliente -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="tipo_cliente" class="form-label">
                                    <i class="bi bi-tag"></i> Tipo de Cliente
                                </label>
                                <select class="form-select" id="tipo_cliente" name="tipo_cliente">
                                    <option value="Particular" {% if not cliente or cliente.tipo_cliente == 'Particular' %}selected{% endif %}>Particular</option>
                                    <option value="Empresa" {% if cliente and cliente.tipo_cliente == 'Empresa' %}selected{% endif %}>Empresa</option>
                                    <option value="Gobierno" {% if cliente and cliente.tipo_cliente == 'Gobierno' %}selected{% endif %}>Gobierno</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Información de Contacto -->
                            <div class="col-12">
                                <h6 class="text-success mb-3 mt-3">
                                    <i class="bi bi-telephone"></i> Información de Contacto
                                </h6>
                            </div>
                            
                            <!-- Teléfono -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="telefono" class="form-label">
                                    <i class="bi bi-telephone"></i> Teléfono
                                </label>
                                <div class="input-group">
                                    <input type="tel" 
                                           class="form-control" 
                                           id="telefono" 
                                           name="telefono"
                                           value="{{ cliente.telefono if cliente and cliente.telefono else '' }}"
                                           maxlength="20"
                                           placeholder="+54 9 2302-672827">
                                    <button class="btn btn-outline-secondary" type="button" id="togglePhoneFormat" title="Deshabilitar formato automático">
                                        <i class="bi bi-slash-circle" id="formatIcon"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> 
                                        Formato automático: +54 9 2302-672827
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Email -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="email" class="form-label">
                                    <i class="bi bi-envelope"></i> Email
                                </label>
                                <input type="email" 
                                       class="form-control" 
                                       id="email" 
                                       name="email"
                                       value="{{ cliente.email if cliente and cliente.email else '' }}"
                                       maxlength="100"
                                       placeholder="cliente@ejemplo.com">
                                <div class="invalid-feedback">
                                    Ingrese un email válido.
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Información de Ubicación -->
                            <div class="col-12">
                                <h6 class="text-info mb-3 mt-3">
                                    <i class="bi bi-geo-alt"></i> Información de Ubicación
                                </h6>
                            </div>
                            
                            <!-- Dirección -->
                            <div class="col-12 mb-3">
                                <label for="direccion" class="form-label">
                                    <i class="bi bi-house"></i> Dirección
                                </label>
                                <textarea class="form-control" 
                                          id="direccion" 
                                          name="direccion"
                                          rows="2"
                                          maxlength="200"
                                          placeholder="Dirección completa del cliente">{{ cliente.direccion if cliente and cliente.direccion else '' }}</textarea>
                            </div>
                            
                            <!-- Ciudad -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="ciudad" class="form-label">
                                    <i class="bi bi-building"></i> Ciudad
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="ciudad" 
                                       name="ciudad"
                                       value="{{ cliente.ciudad if cliente and cliente.ciudad else '' }}"
                                       maxlength="50"
                                       placeholder="Ciudad">
                            </div>
                            
                            <!-- Código Postal -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="codigo_postal" class="form-label">
                                    <i class="bi bi-mailbox"></i> Código Postal
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="codigo_postal" 
                                       name="codigo_postal"
                                       value="{{ cliente.codigo_postal if cliente and cliente.codigo_postal else '' }}"
                                       maxlength="10"
                                       placeholder="1234">
                            </div>
                        </div>

                        <div class="row">
                            <!-- Información Fiscal -->
                            <div class="col-12">
                                <h6 class="text-warning mb-3 mt-3">
                                    <i class="bi bi-file-text"></i> Información Fiscal
                                </h6>
                            </div>
                            
                            <!-- CUIT/DNI -->
                            <div class="col-12 col-md-6 mb-3">
                                <label for="cuit_dni" class="form-label">
                                    <i class="bi bi-card-text"></i> CUIT/DNI
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="cuit_dni" 
                                       name="cuit_dni"
                                       value="{{ cliente.cuit_dni if cliente and cliente.cuit_dni else '' }}"
                                       maxlength="15"
                                       placeholder="20-12345678-9">
                            </div>
                            
                            {% if cliente %}
                            <!-- Estado (solo en edición) -->
                            <div class="col-12 col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="bi bi-toggle-on"></i> Estado
                                </label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="activo" 
                                           name="activo"
                                           {% if cliente.activo %}checked{% endif %}>
                                    <label class="form-check-label" for="activo">
                                        Cliente activo
                                    </label>
                                </div>
                                <small class="text-muted">Los clientes inactivos no aparecen en las búsquedas</small>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Notas -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-secondary mb-3 mt-3">
                                    <i class="bi bi-journal-text"></i> Notas Adicionales
                                </h6>
                                <div class="mb-3">
                                    <textarea class="form-control" 
                                              id="notas" 
                                              name="notas"
                                              rows="3"
                                              maxlength="500"
                                              placeholder="Notas adicionales sobre el cliente...">{{ cliente.notas if cliente and cliente.notas else '' }}</textarea>
                                    <div class="form-text">Máximo 500 caracteres</div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <a href="{% if cliente %}/cliente/{{ cliente.id }}{% else %}/clientes{% endif %}" 
                                       class="btn btn-secondary">
                                        <i class="bi bi-arrow-left"></i> Cancelar
                                    </a>
                                    <button type="submit" class="btn {% if cliente %}btn-warning{% else %}btn-primary{% endif %}">
                                        <i class="bi {% if cliente %}bi-check-circle{% else %}bi-plus-circle{% endif %}"></i>
                                        {% if cliente %}Actualizar Cliente{% else %}Crear Cliente{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Información adicional para edición -->
            {% if cliente %}
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle text-info"></i> Información del Cliente
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 col-md-3 mb-2">
                            <strong>Fecha de Registro:</strong><br>
                            <span class="text-muted">{{ cliente.fecha_registro.strftime('%d/%m/%Y') }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong>Equipos:</strong><br>
                            <span class="badge bg-primary">{{ cliente.equipos.count() }}</span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong>Estado:</strong><br>
                            <span class="badge {% if cliente.activo %}bg-success{% else %}bg-danger{% endif %}">
                                {% if cliente.activo %}Activo{% else %}Inactivo{% endif %}
                            </span>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <strong>Tipo:</strong><br>
                            <span class="text-muted">{{ cliente.tipo_cliente }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .animate-slide {
        animation: slideIn 0.4s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(26, 58, 82, 0.25);
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    h6 {
        border-bottom: 2px solid;
        padding-bottom: 5px;
        margin-bottom: 15px !important;
    }
    
    .text-primary { border-color: var(--primary-color) !important; }
    .text-success { border-color: var(--success-color) !important; }
    .text-info { border-color: var(--info-color) !important; }
    .text-warning { border-color: var(--warning-color) !important; }
    .text-secondary { border-color: var(--text-muted) !important; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('clienteForm');
    const nombreInput = document.getElementById('nombre');
    const emailInput = document.getElementById('email');
    
    // Validación personalizada
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });
    
    // Validación de email en tiempo real
    emailInput.addEventListener('input', function() {
        const email = this.value.trim();
        if (email && !isValidEmail(email)) {
            this.setCustomValidity('Ingrese un email válido');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Formateo automático de teléfono argentino
    const telefonoInput = document.getElementById('telefono');
    const toggleFormatBtn = document.getElementById('togglePhoneFormat');
    const formatIcon = document.getElementById('formatIcon');
    let formatEnabled = true;
    
    // Función para formatear teléfono argentino
    function formatArgentinePhone(value) {
        // Remover todos los caracteres no numéricos
        let cleanValue = value.replace(/\D/g, '');
        
        if (cleanValue.length === 0) return '';
        
        // Si empieza con 54, es código de país
        if (cleanValue.startsWith('54')) {
            if (cleanValue.length <= 2) return '+' + cleanValue;
            if (cleanValue.length <= 4) return '+' + cleanValue.substring(0, 2) + ' ' + cleanValue.substring(2);
            if (cleanValue.length <= 6) return '+' + cleanValue.substring(0, 2) + ' ' + cleanValue.substring(2, 4) + ' ' + cleanValue.substring(4);
            if (cleanValue.length <= 10) return '+' + cleanValue.substring(0, 2) + ' ' + cleanValue.substring(2, 4) + ' ' + cleanValue.substring(4, 8) + '-' + cleanValue.substring(8);
            return '+' + cleanValue.substring(0, 2) + ' ' + cleanValue.substring(2, 4) + ' ' + cleanValue.substring(4, 8) + '-' + cleanValue.substring(8, 12);
        }
        
        // Si no empieza con 54, agregar código de país
        if (cleanValue.length <= 2) return '+54 ' + cleanValue;
        if (cleanValue.length <= 4) return '+54 ' + cleanValue.substring(0, 2) + ' ' + cleanValue.substring(2);
        if (cleanValue.length <= 8) return '+54 ' + cleanValue.substring(0, 2) + ' ' + cleanValue.substring(2, 6) + '-' + cleanValue.substring(6);
        return '+54 ' + cleanValue.substring(0, 2) + ' ' + cleanValue.substring(2, 6) + '-' + cleanValue.substring(6, 10);
    }
    
    // Event listener para formateo automático
    telefonoInput.addEventListener('input', function() {
        if (formatEnabled) {
            const cursorPosition = this.selectionStart;
            const oldValue = this.value;
            const newValue = formatArgentinePhone(this.value);
            
            this.value = newValue;
            
            // Ajustar posición del cursor
            const lengthDiff = newValue.length - oldValue.length;
            this.setSelectionRange(cursorPosition + lengthDiff, cursorPosition + lengthDiff);
        }
    });
    
    // Toggle para habilitar/deshabilitar formato
    toggleFormatBtn.addEventListener('click', function() {
        formatEnabled = !formatEnabled;
        
        if (formatEnabled) {
            formatIcon.className = 'bi bi-slash-circle';
            this.title = 'Deshabilitar formato automático';
            this.classList.remove('btn-danger');
            this.classList.add('btn-outline-secondary');
            
            // Aplicar formato al valor actual
            telefonoInput.value = formatArgentinePhone(telefonoInput.value);
        } else {
            formatIcon.className = 'bi bi-check-circle';
            this.title = 'Habilitar formato automático';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-danger');
        }
    });
    
    // Formateo automático de CUIT/DNI
    const cuitInput = document.getElementById('cuit_dni');
    cuitInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length >= 8) {
            if (value.length === 8) {
                // DNI
                value = value.replace(/(\d{2})(\d{3})(\d{3})/, '$1.$2.$3');
            } else if (value.length === 11) {
                // CUIT
                value = value.replace(/(\d{2})(\d{8})(\d{1})/, '$1-$2-$3');
            }
        }
        this.value = value;
    });
    
    // Auto-capitalizar nombre
    nombreInput.addEventListener('input', function() {
        this.value = this.value.replace(/\b\w/g, l => l.toUpperCase());
    });
    
    // Función auxiliar para validar email
    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    
    // Enfocar primer campo
    nombreInput.focus();
});
</script>
{% endblock %}
